<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Coordination Opération (Éditable, Tâches complétées)</title>
    <style>
        body {
            background: #0b3e6f;
            font-family: "Arial", sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .board {
            /* Use full width to allow all pillars to be visible horizontally */
            max-width: none;
            width: 100%;
            margin: 30px auto;
            padding: 10px;
        }
        .header {
            /* Use flex to align company logo and title */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #ffffff;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .company-logo {
            height: 40px;
            user-select: none;
        }
        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }
        .toolbar button {
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #addCategoryBtn {
            /* Use AEM blue tone for primary action */
            background-color: #0071c4;
            color: #ffffff;
        }
        #addCategoryBtn:hover {
            background-color: #005a9e;
        }
        #completedBtn {
            /* Use a secondary blue tone */
            background-color: #005a9e;
            color: #ffffff;
        }
        #completedBtn:hover {
            background-color: #004070;
        }
        .grid {
            /* Arrange categories as horizontal pillars */
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 15px;
            /* Constrain height so everything fits on one page; allow horizontal scrolling for overflow */
            max-height: calc(100vh - 180px);
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* Each card acts as a pillar with its own vertical scrolling */
        .card {
            flex: 0 0 280px;
            max-height: 100%;
            overflow-y: auto;
        }
        .card {
            background: #ffffff;
            border-radius: 8px;
            padding: 12px 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            /* allow absolute positioning for delete button */
            position: relative;
            /* Allow cards to be dragged */
            /* The draggable attribute will be set via JavaScript, but we set user-select here to ensure text isn't selected while dragging */
            user-select: none;
        }
            .card h3 {
                /* Use flexbox so the delete category button can align to the right of the title */
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0 0 8px 0;
                font-size: 16px;
                color: #0b3e6f;
                border-bottom: 2px solid #0b3e6f;
                padding-bottom: 4px;
            }
        .card ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }
        /* Highlight a card while it is being dragged */
        .card.dragging {
            opacity: 0.6;
        }
        .card ul li {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            /* Align text on the left and checkbox on the right */
            justify-content: space-between;
        }
        .task-checkbox {
            transform: scale(1.1);
            /* Place a left margin to separate from text when appended */
            margin-left: 6px;
        }
        [contenteditable="true"]:focus {
            outline: 2px dashed #ff9800;
        }
        .subsection {
            margin-top: 10px;
        }
        .subsection h4 {
            margin: 6px 0 4px;
            font-size: 14px;
            color: #0b3e6f;
            font-weight: bold;
            border-bottom: 1px solid #0b3e6f;
            padding-bottom: 2px;
        }
        .subsection ul li {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: space-between;
        }
        /* Style pour les boutons d'ajout de ligne */
        .add-row {
            align-self: flex-start;
            margin: 4px 0 6px 0;
            background-color: #e7eaf3;
            color: #0b3e6f;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .add-row:hover {
            background-color: #d3d8e0;
        }

        /* Comment section and delete button styles */
        /* Override the default list item layout to use a three‑column grid: delete button, text, checkbox */
        .card ul li, .subsection ul li {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 6px;
        }
        /* Red delete icon appearing on each row */
        .delete-btn {
            color: #dc3545;
            cursor: pointer;
            user-select: none;
        }
        /* Container for per‑category comments */
        .comment-section {
            margin-top: 10px;
            border-top: 1px dashed #0b3e6f;
            padding-top: 6px;
        }
        .comment-section h4 {
            margin: 4px 0 4px;
            font-size: 14px;
            color: #0b3e6f;
            font-weight: bold;
        }
        .comment-area {
            min-height: 40px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            padding: 4px;
            border-radius: 4px;
        }
        /* Delete category button */
        .delete-category {
            position: absolute;
            top: 4px;
            right: 6px;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            user-select: none;
            z-index: 10;
        }
    </style>
</head>
<body>
<div class="board">
        <!-- Header with company logo and editable title -->
        <div class="header">
            <img src="logo.png" alt="AEM Logo" class="company-logo">
            <span class="header-text" contenteditable="true">Coordination Opération</span>
        </div>
    <!-- Toolbar with actions -->
    <div class="toolbar">
        <button id="addCategoryBtn">+ Ajouter une catégorie</button>
        <button id="completedBtn">Voir tâches complétées</button>
    </div>
    <!-- Grid for cards -->
    <div class="grid" id="grid">
        <!-- Réorganisation : une seule colonne avec regroupements demandés -->
        <div class="card">
            <h3 contenteditable="true">SST / Environnement</h3>
            <ul>
                <li contenteditable="true">Pont roulant HX9 – 08/07</li>
                <li contenteditable="true">Varin – 04/08</li>
                <li contenteditable="true">M3 FID – 30/07</li>
            </ul>
            <div class="subsection">
                <h4 contenteditable="true">Cadencassage</h4>
                <ul>
                    <li contenteditable="true">Total : 305</li>
                    <li contenteditable="true">Brouillon : 48</li>
                    <li contenteditable="true">En cours : 55</li>
                    <li contenteditable="true">Terminé : 202 (66 %)</li>
                </ul>
            </div>
        </div>
        <div class="card">
            <h3 contenteditable="true">Production et point de vigilance</h3>
            <ul>
                <li contenteditable="true">M7 atérminé : 1000 kg</li>
                <li contenteditable="true">MD2 minipilot : 200 kg</li>
                <li contenteditable="true">780 kg slurry BDO : 11 août</li>
                <li contenteditable="true">Suite à venir : CRB</li>
            </ul>
            <div class="subsection">
                <h4 contenteditable="true">À risque</h4>
                <ul>
                    <li contenteditable="true">CF10‑AGO‑PO1 (spare ?)</li>
                    <li contenteditable="true">Seal agitateur BD01</li>
                    <li contenteditable="true">Big bag – EIV inventaire : 125</li>
                </ul>
            </div>
            <div class="subsection">
                <h4 contenteditable="true">En suivi</h4>
                <ul>
                    <!-- Tous les éléments en suivi qui étaient en double ailleurs ont été retirés -->
                </ul>
            </div>
            <div class="subsection">
                <h4 contenteditable="true">Informatif</h4>
                <ul>
                    <li contenteditable="true">Cadencassage terminé : 202 (66 %)</li>
                    <li contenteditable="true">HCl actuel : 39 % (cible 45 %)</li>
                    <li contenteditable="true">M3 FID prévu : 30/07</li>
                </ul>
            </div>
        </div>
        <div class="card">
            <h3 contenteditable="true">Matières premières</h3>
            <ul>
                <li contenteditable="true">HCl : 39 % (cible 45 %)</li>
                <li contenteditable="true">HXK : 68 %</li>
                <li contenteditable="true">NaOH : 62 %</li>
                <li contenteditable="true">Filtrat : 9 %</li>
                <li contenteditable="true">Fuel : 5 cttes (cette semaine)</li>
            </ul>
        </div>
        <div class="card">
            <h3 contenteditable="true">Entretien mécanique</h3>
            <ul>
                <li contenteditable="true">GICO à réparer (Mike)</li>
                <li contenteditable="true">HPGO‑AGO‑K03 : board reçu brisé</li>
                <li contenteditable="true">D02 : seal mécanique</li>
                <li contenteditable="true">HPGO‑AGO‑PO1 : boyau à changer</li>
                <li contenteditable="true">Nourrice Merlin : à changer (Mike)</li>
                <li contenteditable="true">CF10‑AGO‑PO1 : à réparer</li>
            </ul>
        </div>
        <div class="card">
            <h3 contenteditable="true">Statut équipement</h3>
            <ul>
                <li contenteditable="true">Digestion 518 : stand‑by</li>
                <li contenteditable="true">Cristallisation : en attente du seal</li>
                <li contenteditable="true">Centrifugeuse : stand‑by</li>
                <li contenteditable="true">Hammer 1 : en stand‑by</li>
                <li contenteditable="true">Hammer 2 : off</li>
                <li contenteditable="true">Meca pulse 1 : stand‑by</li>
                <li contenteditable="true">Meca pulse 3 : à inspecter (pression positive)</li>
                <li contenteditable="true">F 71 : stand‑by</li>
                <li contenteditable="true">Laboratoire : stand‑by</li>
                <li contenteditable="true">Alcool chambre 500 : à planifier</li>
                <li contenteditable="true">PLCK : en réflexion</li>
                <li contenteditable="true">Boiler & Cie : en fonction</li>
                <li contenteditable="true">Jet Hell : stand‑by</li>
                <li contenteditable="true">SOZ : attente modification</li>
                <li contenteditable="true">FO4 : à vider / remplir</li>
                <li contenteditable="true">HK : 175 kg (1er), 245 kg (2e)</li>
            </ul>
        </div>
        <div class="card">
            <h3 contenteditable="true">Propreté / Bon ordre</h3>
            <div class="subsection">
                <h4 contenteditable="true">Ménage</h4>
                <ul>
                    <li contenteditable="true">Laver cuve HXK</li>
                    <li contenteditable="true">Remplacer pièce HCl</li>
                    <li contenteditable="true">Vérifier fond à vider (OK)</li>
                    <li contenteditable="true">Peindre cadre porte grange</li>
                    <li contenteditable="true">Tapisser l’intérieur des poubelles</li>
                </ul>
            </div>
            <div class="subsection">
                <h4 contenteditable="true">Actions Nisshin</h4>
                <ul>
                    <li contenteditable="true">Audit hypochlorite</li>
                    <li contenteditable="true">Audit hypotraction</li>
                    <li contenteditable="true">Audit extérieur</li>
                    <li contenteditable="true">Audit magasin</li>
                </ul>
            </div>
        </div>
        <div class="card">
            <h3 contenteditable="true">Ingénierie</h3>
            <div class="subsection">
                <h4 contenteditable="true">Projets</h4>
                <ul>
                    <li contenteditable="true">FO4 – ventilateur à déplacer</li>
                    <li contenteditable="true">R03 – travaux à venir</li>
                    <li contenteditable="true">Robot FIO – réparation à suivre</li>
                    <li contenteditable="true">Salle blanche – chauffage & ventilation</li>
                    <li contenteditable="true">Pellet</li>
                    <li contenteditable="true">Presse</li>
                    <li contenteditable="true">Phadia</li>
                    <li contenteditable="true">Détecteur HCl</li>
                </ul>
            </div>
            <div class="subsection">
                <h4 contenteditable="true">Technique</h4>
                <ul>
                    <li contenteditable="true">Lavage SO<sub>2</sub></li>
                    <li contenteditable="true">Cristalliseur</li>
                    <li contenteditable="true">Distillat acide</li>
                    <li contenteditable="true">FB01</li>
                    <li contenteditable="true">Test CM + nettoyage prioritaire</li>
                    <li contenteditable="true">Test DRM</li>
                    <li contenteditable="true">CMI Harper – planifier nettoyage</li>
                </ul>
            </div>
        </div>
        <div class="card">
            <h3 contenteditable="true">Opportunité</h3>
            <ul>
                <li contenteditable="true">Améliorer la récupération de fer</li>
                <li contenteditable="true">Augmenter le rendement</li>
                <li contenteditable="true">Optimiser le flux de production</li>
                <li contenteditable="true">Exploiter l’inventaire des big bags</li>
            </ul>
        </div>
    </div>
</div>
<script>
// Function to add checkboxes and attach event for completion
function wrapListItems() {
    document.querySelectorAll('.card ul li, .subsection ul li').forEach(li => {
        if (!li.querySelector('input[type="checkbox"]')) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            if (!li.dataset.created) {
                li.dataset.created = Date.now();
            }
            // Append the checkbox to the end of the list item so it appears after the text
            li.appendChild(checkbox);
            checkbox.addEventListener('change', function () {
                if (checkbox.checked) {
                    const taskText = li.textContent.trim();
                    const category = li.closest('.card').querySelector('h3').textContent.trim();
                    const dateCompleted = new Date().toLocaleDateString('fr-CA');
                    const entry = { category: category, task: taskText, dateCompleted: dateCompleted };
                    let completed = [];
                    try {
                        completed = JSON.parse(localStorage.getItem('completedTasks') || '[]');
                    } catch (e) { completed = []; }
                    completed.push(entry);
                    localStorage.setItem('completedTasks', JSON.stringify(completed));
                    // remove the list item from its parent
                    li.remove();
                // Persist board state after removal
                saveBoardState();
                }
            });
        }
    });
    // After ensuring checkboxes are attached, also ensure delete buttons exist
    attachDeleteButtons();
}

// Attach delete buttons to each list item (adds an 'x' button at the beginning)
function attachDeleteButtons() {
    document.querySelectorAll('.card ul li, .subsection ul li').forEach(li => {
        if (!li.querySelector('.delete-btn')) {
            const del = document.createElement('span');
            del.className = 'delete-btn';
            del.textContent = '✖';
            // Prevent editing of the delete button itself
            del.setAttribute('contenteditable', 'false');
            del.addEventListener('click', function (e) {
                e.stopPropagation();
                li.remove();
                // Save the board state after removing an item
                saveBoardState();
            });
            // Insert the delete button as the first child of the list item
            li.insertBefore(del, li.firstChild);
        }
    });
}

// Attach comment sections to each card with an editable title and area
function attachCommentSections() {
    document.querySelectorAll('.card').forEach(card => {
        if (!card.querySelector('.comment-section')) {
            const commentSec = document.createElement('div');
            commentSec.className = 'comment-section';
            const title = document.createElement('h4');
            title.setAttribute('contenteditable', 'true');
            title.textContent = 'Commentaire';
            commentSec.appendChild(title);
            const area = document.createElement('div');
            area.className = 'comment-area';
            area.setAttribute('contenteditable', 'true');
            commentSec.appendChild(area);
            card.appendChild(commentSec);
        }
    });
}

// Attach delete buttons to each card to allow removing categories
function attachDeleteCategoryButtons() {
    document.querySelectorAll('.card').forEach(card => {
        const header = card.querySelector('h3');
        // ensure we don't add multiple delete buttons within the header
        if (header && !header.querySelector('.delete-category')) {
            const btn = document.createElement('span');
            btn.className = 'delete-category';
            btn.textContent = '✖';
            btn.setAttribute('contenteditable', 'false');
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                card.remove();
                // Save board state after removing a category
                saveBoardState();
            });
            // Append button to the header so it appears next to the title
            header.appendChild(btn);
        }
    });
}

// Function to create add-row button
function createAddRowButton(ul) {
    const btn = document.createElement('button');
    btn.className = 'add-row';
    btn.textContent = '+ Ligne';
    btn.addEventListener('click', function () {
        const li = document.createElement('li');
        li.setAttribute('contenteditable', 'true');
        li.textContent = 'Nouvelle ligne';
        li.dataset.created = Date.now();
        ul.appendChild(li);
        // Reapply checkboxes and delete buttons for the new row
        wrapListItems();
        attachDeleteButtons();
        // Persist state after adding a new line
        saveBoardState();
    });
    return btn;
}
// Function to attach row buttons to existing lists
function attachRowButtons() {
    document.querySelectorAll('.card').forEach(card => {
        card.querySelectorAll(':scope > ul, .subsection > ul').forEach(ul => {
            if (!ul.previousElementSibling || !ul.previousElementSibling.classList || !ul.previousElementSibling.classList.contains('add-row')) {
                const btn = createAddRowButton(ul);
                ul.parentNode.insertBefore(btn, ul);
            }
        });
    });
}

// Save the current board state (excluding checkboxes and add-row buttons) to localStorage
function saveBoardState() {
    const grid = document.getElementById('grid');
    // Clone the grid to avoid modifying the live DOM during cleanup
    const clone = grid.cloneNode(true);
    // Remove all checkboxes so they will be recreated on load
    clone.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.remove());
    // Remove add-row buttons; they will be recreated by attachRowButtons()
    clone.querySelectorAll('.add-row').forEach(btn => btn.remove());
    // Remove category delete buttons so they will be recreated on load
    clone.querySelectorAll('.delete-category').forEach(btn => btn.remove());
    // Store the sanitized HTML
    localStorage.setItem('boardHTML', clone.innerHTML);
}

// -------- Drag and Drop Implementation --------

// Global variable to store the element being dragged
let dragSrcEl = null;

// Attach drag & drop attributes and handlers to each card
function enableDragAndDrop() {
    const grid = document.getElementById('grid');
    if (!grid) return;
    // Loop through all cards and set them as draggable
    grid.querySelectorAll('.card').forEach(card => {
        card.setAttribute('draggable', 'true');
        // Remove any previously attached listeners to avoid duplicates
        card.removeEventListener('dragstart', handleDragStart);
        card.removeEventListener('dragover', handleDragOver);
        card.removeEventListener('drop', handleDrop);
        card.removeEventListener('dragend', handleDragEnd);
        // Attach events
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
    });
}

// Handler for when dragging starts
function handleDragStart(e) {
    dragSrcEl = this;
    this.classList.add('dragging');
    // Set the allowed effect to move
    e.dataTransfer.effectAllowed = 'move';
    // For Firefox compatibility, must set some data
    try {
        e.dataTransfer.setData('text/html', this.innerHTML);
    } catch (err) {
        // ignore, not all browsers require data
    }
}

// Handler for when dragging over another card; must prevent default to allow drop
function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

// Handler for dropping onto another card
function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    // Only proceed if the source and target are different
    if (dragSrcEl && dragSrcEl !== this) {
        const grid = document.getElementById('grid');
        const cards = Array.from(grid.children);
        const srcIndex = cards.indexOf(dragSrcEl);
        const targetIndex = cards.indexOf(this);
        // Determine insertion point based on index
        if (srcIndex < targetIndex) {
            grid.insertBefore(dragSrcEl, this.nextSibling);
        } else {
            grid.insertBefore(dragSrcEl, this);
        }
        // After reordering, persist the new state
        saveBoardState();
        // Reassign colours to reflect new order
        assignColors();
    }
    return false;
}

// Handler for when drag ends; cleanup visual class
function handleDragEnd() {
    this.classList.remove('dragging');
}

// -------- Category color assignment --------

// Define a palette of soft background colors to distinguish categories. Feel free to adjust or expand this list.
const categoryColors = [
    '#e3f2fd', // light blue
    '#e8f5e9', // light green
    '#fff3e0', // light orange
    '#fce4ec', // light pink
    '#ede7f6', // light purple
    '#f9fbe7'  // light yellow
];

// Assign a background color to each card based on its order in the grid
function assignColors() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        const color = categoryColors[index % categoryColors.length];
        card.style.backgroundColor = color;
    });
}

// Load the board state from localStorage if it exists
function loadBoardState() {
    const grid = document.getElementById('grid');
    const saved = localStorage.getItem('boardHTML');
    if (saved) {
        grid.innerHTML = saved;
    }
    // Reattach row buttons and checkboxes after loading the content
    attachRowButtons();
    wrapListItems();
    // Add comment sections and delete buttons after restoring list items
    attachCommentSections();
    attachDeleteButtons();
    // Add delete-category buttons after restoring list items
    attachDeleteCategoryButtons();
    // Enable drag‑and‑drop functionality on all loaded cards
    enableDragAndDrop();
    // Assign colours to each card
    assignColors();
}
// Function to create new card
function createCard(title) {
    const card = document.createElement('div');
    card.className = 'card';
    const h3 = document.createElement('h3');
    h3.setAttribute('contenteditable', 'true');
    h3.textContent = title || 'Nouvelle catégorie';
    card.appendChild(h3);
    const ul = document.createElement('ul');
    card.appendChild(ul);
    const addBtn = createAddRowButton(ul);
    card.insertBefore(addBtn, ul);
    // Add a comment section to the new card
    attachCommentSections();
    // Add delete buttons to existing rows (if any)
    attachDeleteButtons();
    // Add a delete button to the new category
    attachDeleteCategoryButtons();
    // Persist state after creating a new card
    saveBoardState();
    // Enable drag‑and‑drop for this new card and any others
    enableDragAndDrop();
    // Assign colours after creating a new card
    assignColors();
    return card;
}
// Initial setup: load any saved board state or default if none
loadBoardState();
// Add category button
document.getElementById('addCategoryBtn').addEventListener('click', function () {
    const title = prompt('Nom de la nouvelle catégorie :');
    const card = createCard(title || 'Nouvelle catégorie');
    document.getElementById('grid').appendChild(card);
    // Reapply list item helpers for the new category
    wrapListItems();
    attachCommentSections();
    attachDeleteButtons();
    attachDeleteCategoryButtons();
    // Persist state after adding a new category
    saveBoardState();
    // Re-enable drag‑and‑drop to include the new card
    enableDragAndDrop();
    // Reassign colours after adding a new category
    assignColors();
});
// Completed tasks button
document.getElementById('completedBtn').addEventListener('click', function () {
    window.open('completed.html', '_blank');
});

// Persist changes whenever a contenteditable element loses focus
document.addEventListener('blur', function (e) {
    const target = e.target;
    if (target && target.getAttribute && target.getAttribute('contenteditable') === 'true') {
        saveBoardState();
    }
}, true);
</script>
</body>
</html>
